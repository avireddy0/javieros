services:
  open-webui:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://openwebui:openwebui@db:5432/openwebui
      - WEBUI_SECRET_KEY=dev-secret-key
      - OAUTH_CLIENT_INFO_ENCRYPTION_KEY=${OAUTH_CLIENT_INFO_ENCRYPTION_KEY:-dev-oauth-client-key-change-in-production}
      - OAUTH_SESSION_TOKEN_ENCRYPTION_KEY=${OAUTH_SESSION_TOKEN_ENCRYPTION_KEY:-dev-oauth-session-key-change-in-production}
      - WEBUI_AUTH=true
      - WEBUI_ADMIN_EMAIL=${WEBUI_ADMIN_EMAIL:-jabarrios@flow.life}
      - WEBUI_ADMIN_NAME=${WEBUI_ADMIN_NAME:-Javier Barrios}
      - WEBUI_ADMIN_PASSWORD=${WEBUI_ADMIN_PASSWORD:-change-me-before-production}
      - ENABLE_SIGNUP=false
      - ENABLE_OPENAI_API=true
      - OPENAI_API_BASE_URL=https://api.openai.com/v1
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - WHATSAPP_API_TOKEN=${WHATSAPP_API_TOKEN}
      - WHATSAPP_API_BASE_URL=http://whatsapp-api:8000
      - WHATSAPP_QR_COOKIE_SECURE=false
      - ENABLE_OLLAMA_API=false
      - ENABLE_FORWARD_USER_INFO_HEADERS=false
      - WEBUI_URL=http://localhost:8080
      - CORS_ALLOW_ORIGIN=http://localhost:8080;http://127.0.0.1:8080
      - DEFAULT_MODELS=gpt-5.2-chat-latest
      - TASK_MODEL=gpt-5.2-chat-latest
      - TASK_MODEL_EXTERNAL=gpt-5.2-chat-latest
      - DEFAULT_LOCALE=en
      - ENABLE_PERSISTENT_CONFIG=true
      - ENABLE_OAUTH_PERSISTENT_CONFIG=true
      - WEBUI_SESSION_COOKIE_SAME_SITE=lax
      - WEBUI_AUTH_COOKIE_SAME_SITE=lax
      - ENABLE_BASE_MODELS_CACHE=true
      - MODELS_CACHE_TTL=300
      - THREAD_POOL_SIZE=128
      - ENABLE_DIRECT_CONNECTIONS=true
      - ENABLE_WEB_SEARCH=true
      - WEB_SEARCH_ENGINE=duckduckgo
      - WEB_SEARCH_RESULT_COUNT=5
      - WEB_SEARCH_CONCURRENT_REQUESTS=2
      - WEB_LOADER_CONCURRENT_REQUESTS=5
      - TOOL_SERVER_CONNECTIONS=[{"type":"mcp","url":"https://envision-mcp-845049957105.us-central1.run.app","path":"/mcp","auth_type":"none","headers":{},"key":"","config":{"enable":true,"function_name_filter_list":"","access_control":null},"info":{"id":"envision-mcp","name":"Envision MCP","description":"Construction intelligence and project systems via MCP (streamable HTTP)."}},{"type":"mcp","url":"https://slack-mcp-210087613384.us-central1.run.app","path":"/mcp","spec_type":"url","spec":"","auth_type":"oauth_2.1","headers":{},"key":"","config":{"enable":true,"function_name_filter_list":"","access_control":null},"info":{"id":"slack-oauth","name":"Slack OAuth","description":"Slack workspace tools with OAuth 2.1."}},{"type":"mcp","url":"https://workspace-mcp-210087613384.us-central1.run.app","path":"/mcp","spec_type":"url","spec":"","auth_type":"oauth_2.1","headers":{},"key":"","config":{"enable":true,"function_name_filter_list":"","access_control":null},"info":{"id":"google-workspace","name":"Google Workspace","description":"Google Workspace MCP tools via OAuth 2.1."}},{"type":"mcp","url":"http://whatsapp-mcp:8001","path":"/sse","spec_type":"url","spec":"","auth_type":"none","headers":{},"key":"","config":{"enable":true,"function_name_filter_list":"","access_control":null},"info":{"id":"whatsapp-mcp","name":"WhatsApp MCP","description":"WhatsApp messaging with per-user session isolation via MCP."}},{"type":"openapi","url":"http://messaging-service:8005","path":"/openapi.json","spec_type":"url","spec":"","auth_type":"none","headers":{},"key":"","config":{"enable":true,"function_name_filter_list":"","access_control":null},"info":{"id":"messaging","name":"Messaging Bridges","description":"Telegram, Discord, and Teams messaging bridges."}}]
      # Optional native Anthropic support
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CRON_TOKEN=${CRON_TOKEN}
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_USER=openwebui
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env}
      - POSTGRES_DB=openwebui
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # ── WhatsApp ────────────────────────────────────────────────
  # whatsapp-bridge: Baileys session service (QR auth)
  # whatsapp-api:   FastAPI wrapper registered as OpenAPI tool server

  whatsapp-bridge:
    build: ./whatsapp-bridge
    ports:
      - "3000:3000"
    environment:
      - WHATSAPP_BRIDGE_TOKEN=${WHATSAPP_BRIDGE_TOKEN}
    volumes:
      - whatsapp-data:/data
    restart: unless-stopped

  whatsapp-mcp:
    build: ./servers/whatsapp-mcp
    ports:
      - "8001:8001"
    environment:
      - WHATSAPP_BRIDGE_URL=http://whatsapp-bridge:3000
      - WHATSAPP_BRIDGE_TOKEN=${WHATSAPP_BRIDGE_TOKEN}
    depends_on:
      - whatsapp-bridge
    restart: unless-stopped

  whatsapp-api:
    build: ./servers/whatsapp
    ports:
      - "8003:8000"
    environment:
      - WHATSAPP_BRIDGE_URL=http://whatsapp-bridge:3000
      - WHATSAPP_BRIDGE_TOKEN=${WHATSAPP_BRIDGE_TOKEN}
      - WHATSAPP_API_TOKEN=${WHATSAPP_API_TOKEN}
      - WHATSAPP_ALLOWED_ORIGINS=http://localhost:8080
    depends_on:
      - whatsapp-bridge
    restart: unless-stopped

  # ── Memory Service ────────────────────────────────────────
  # GCS-backed per-user markdown file storage sidecar

  memory-service:
    build: ./servers/memory
    ports:
      - "8004:8003"
    environment:
      - MEMORY_API_TOKEN=${MEMORY_API_TOKEN}
      - GCS_BUCKET_NAME=javieros-memory
      - MEMORY_ALLOWED_ORIGINS=http://localhost:8080
      - CRON_TOKEN=${CRON_TOKEN}
      - OPENWEBUI_API_KEY=${OPENWEBUI_API_KEY}
    restart: unless-stopped

  # ── Messaging Service ──────────────────────────────────────
  # Unified Telegram / Discord / Teams bridge (Phase 2)

  messaging-service:
    build: ./servers/messaging
    ports:
      - "8005:8005"
    environment:
      - MESSAGING_API_TOKEN=${MESSAGING_API_TOKEN}
      - OPENWEBUI_BASE_URL=http://open-webui:8080
      - OPENWEBUI_API_KEY=${OPENWEBUI_API_KEY}
      - OPENWEBUI_MODEL=anthropic/claude-sonnet-4-20250514
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_SECRET_TOKEN=${TELEGRAM_SECRET_TOKEN}
      - DISCORD_APP_ID=${DISCORD_APP_ID}
      - DISCORD_PUBLIC_KEY=${DISCORD_PUBLIC_KEY}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - TEAMS_APP_ID=${TEAMS_APP_ID}
      - TEAMS_APP_PASSWORD=${TEAMS_APP_PASSWORD}
    depends_on:
      - open-webui
    restart: unless-stopped

volumes:
  pgdata:
  whatsapp-data:
  memory-data:
